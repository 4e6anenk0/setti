# Основи налаштувань

## Вступ

Бібліотека **Setti** забезпечує зручний і декларативний підхід до управління налаштуваннями в Dart-програмах. Центральним елементом бібліотеки є концепція **налаштувань** (settings), які дозволяють визначати, зберігати та синхронізувати параметри програми. Налаштування представлені через класи `BaseSetting`, `Setting` та спеціалізовані похідні, такі як `EnumSetting`. Цей розділ пояснює, що таке ці класи, як вони працюють, і для чого використовуються в бібліотеці Setti.

## Що таке налаштування?

Налаштування в бібліотеці Setti — це декларативні об’єкти, які описують окремий параметр програми, такий як тема інтерфейсу, розмір шрифту чи мова. Кожен об’єкт налаштування містить:

- **Ідентифікатор (ID)**: Унікальний ключ, який ідентифікує налаштування.
- **Значення за замовчуванням**: Початкове значення, яке використовується, якщо налаштування ще не збережено.
- **Режим збереження**: Визначає, де зберігати значення (локально чи в сесії).
- **Додаткові атрибути**: Наприклад, чи є налаштування декларативним.

Налаштування є основою для роботи `SettiController` і `BaseSetti`, які керують їх ініціалізацією, оновленням і синхронізацією між `SessionStorage` і `StorageOverlay`.

## Як використовуються?

Налаштування (`BaseSetting`, `Setting`, `EnumSetting`) є основними будівельними блоками для конфігурації в `BaseSetti` і `SettiController`. Їхній життєвий цикл включає:

- **Визначення**:

Налаштування визначаються в `Setti` конфігурації через поле `settings` або в слоях (`SettiLayer`):

```dart
class AppConfig extends Setti {
  @override
  List<BaseSetting> get settings => [
        language,
        theme
    ];

  static const language = Setting<String>(
          id: 'language',
          defaultValue: 'en',
          saveMode: SaveMode.local,
        );
  static const theme = EnumSetting<AppTheme>(
          id: 'theme',
          values: AppTheme.values,
          defaultValue: AppTheme.light,
          saveMode: SaveMode.local,
        ),
}
```

- **Ініціалізація**:

Під час виклику `BaseSetti.init` налаштування передаються в `SettiController`, який ініціалізує їх через `_restoreSettings` і `_initLocalSettings`:

```dart
_controller = await SettiController.consist(
  settings: settings,
  converter: converter,
  storageOverlay: overlay,
  isDebug: debug,
  caseFormat: config.caseFormat,
);
```

Декларативні налаштування ініціалізуються з `defaultValue`, якщо їх немає в сховищі. Недекларативні викликають виняток, якщо відсутні в сховищі.

- **Оновлення та синхронізація**:

Налаштування можна оновлювати через `SettiController.update` або оператор `[]=` у `BaseSetti`:

```dart
// Через оператор
config[AppConfig.theme] = AppTheme.dark; // Оновлює в SessionStorage
await config.match(); // Синхронізує з StorageOverlay

// Через метод
await config.update(AppConfig.theme.copyWith(defaultValue: AppTheme.light));
```

- **Доступ**:

Значення отримуються через `SettiController.get` або оператор `[]`:

```dart
var theme = config[AppConfig.theme]; // Повертає AppTheme.dark
// or
var theme = config.get(AppConfig.theme);
```

## Обмеження

- **Унікальність ID**: Усі налаштування в конфігурації повинні мати унікальні `id`, інакше виникне конфлікт.
- **Обмеження типу**: Усі налаштування мають бути визначені з значенням за замовченням і не можуть бути визначені як nullable типи.
- **Декларативні налаштування**: Недекларативні налаштування (`declarative: false`) потребують попереднього збереження в сховищі (файл, тощо), інакше викликають виняток.

## Рекомендації

- **Використовуйте `const` для налаштувань**: Визначайте `Setting` і `EnumSetting` як `const` для оптимізації продуктивності.
- **Уникайте дублювання ID**: Переконайтеся, що кожен `id` унікальний у межах конфігурації та окремо на рівні шарів.
- **Використовуйте `EnumSetting` для категорій**: Для налаштувань із фіксованим набором значень (наприклад, теми чи режими) завжди використовуйте `EnumSetting`.
- **Тестуйте недекларативні налаштування**: Переконайтеся, що недекларативні налаштування збережено в сховищі перед ініціалізацією.
